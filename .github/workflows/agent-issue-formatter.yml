name: Issue Formatter
'on':
  workflow_dispatch:
    inputs:
      progress-comment-id:
        type: string
        required: false
        description: Progress comment ID (from dispatcher)
      progress-issue-number:
        type: string
        required: false
        description: Issue/PR number for progress comment (from dispatcher)
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      should-continue: ${{ steps.setup.outputs.should-continue }}
      app-token: ${{ steps.setup.outputs.app-token }}
      git-user: ${{ steps.setup.outputs.git-user }}
      git-email: ${{ steps.setup.outputs.git-email }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Setup agent
        id: setup
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_APP_ID: ${{ secrets.GH_APP_ID }}
          GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun packages/runtime/src/index.ts run setup --agent .github/agents/issue-lifecycle/issue-formatter.md

  agent:
    runs-on: ubuntu-latest
    needs:
      - setup
    if: needs.setup.outputs.should-continue == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: 'Update progress: agent running'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-formatter.md --progress-stage agent --progress-status running --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ needs.setup.outputs.git-user }}"
          git config --global user.email "${{ needs.setup.outputs.git-email }}"
      - id: run
        run: bun packages/runtime/src/index.ts run agent --agent .github/agents/issue-lifecycle/issue-formatter.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-outputs-${{ github.run_id }}
          path: /tmp/outputs/
      - uses: actions/upload-artifact@v4
        with:
          name: audit-metrics-${{ github.run_id }}
          path: /tmp/audit/
      - name: 'Update progress: agent success'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-formatter.md --progress-stage agent --progress-status success --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
        continue-on-error: true

  execute-outputs:
    runs-on: ubuntu-latest
    needs:
      - setup
      - agent
    strategy:
      matrix:
        output-type:
          - add-comment
          - add-label
          - remove-label
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Download output files
        uses: actions/download-artifact@v4
        with:
          name: claude-outputs-${{ github.run_id }}
          path: /tmp/outputs/
      - name: 'Update progress: outputs running'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-formatter.md --progress-stage outputs --progress-status running --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
        if: matrix.output-type == matrix.output-type[0]
      - name: Execute ${{ matrix.output-type }} outputs
        run: bun packages/runtime/src/index.ts run outputs --agent .github/agents/issue-lifecycle/issue-formatter.md --output-type ${{ matrix.output-type }}
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
          TARGET_ISSUE_NUMBER: ${{ inputs.progress-issue-number }}

  audit-report:
    runs-on: ubuntu-latest
    needs:
      - setup
      - agent
      - execute-outputs
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ github.run_id }}'
          path: /tmp/audit-data/
          merge-multiple: true
        continue-on-error: true
      - run: |-
          bun packages/runtime/src/index.ts run audit --agent .github/agents/issue-lifecycle/issue-formatter.md \
                      --agent-result ${{ needs.agent.result }} \
                      --execute-outputs-result ${{ needs.execute-outputs.result }}
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
      - name: Read final comment
        id: final-comment
        if: needs.agent.result == 'success'
        run: |-
          if [ -f /tmp/audit-data/add-comment.json ]; then
            COMMENT=$(jq -r '.body // empty' /tmp/audit-data/add-comment.json 2>/dev/null || true)
            if [ -n "$COMMENT" ]; then
              echo "has-comment=true" >> $GITHUB_OUTPUT
              # Escape for shell
              ESCAPED=$(echo "$COMMENT" | sed 's/"/\"/g' | tr '\n' ' ')
              echo "comment=$ESCAPED" >> $GITHUB_OUTPUT
            fi
          fi
        continue-on-error: true
      - name: 'Update progress: complete with comment'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-formatter.md --progress-stage complete --progress-status success --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}" --progress-final-comment "${{ steps.final-comment.outputs.comment }}"
        if: needs.agent.result == 'success' && steps.final-comment.outputs.has-comment == 'true'
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: 'Update progress: complete'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-formatter.md --progress-stage complete --progress-status success --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        if: needs.agent.result == 'success' && steps.final-comment.outputs.has-comment != 'true'
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: 'Update progress: failed'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-formatter.md --progress-stage failed --progress-status failed --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}" --progress-error "Workflow failed"
        if: needs.agent.result != 'success'
        env:
          GH_TOKEN: ${{ needs.setup.outputs.app-token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
permissions:
  issues: write
