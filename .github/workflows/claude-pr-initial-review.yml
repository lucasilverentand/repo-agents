name: PR Initial Review
'on':
  pull_request:
    types:
      - opened
      - synchronize
permissions: {}
jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.set-output.outputs.should-run }}
    steps:
      - name: Check secrets
        id: check-secrets
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |-
          if [ -z "${ANTHROPIC_API_KEY}" ] && [ -z "${CLAUDE_CODE_OAUTH_TOKEN}" ]; then
            echo "::error::No Claude authentication found. Please set either ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN in your repository secrets."
            echo "validation-failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -n "${ANTHROPIC_API_KEY}" ]; then
            echo "✓ ANTHROPIC_API_KEY is configured"
          fi
          if [ -n "${CLAUDE_CODE_OAUTH_TOKEN}" ]; then
            echo "✓ CLAUDE_CODE_OAUTH_TOKEN is configured"
          fi
      - name: Check user authorization
        id: check-user
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          ACTOR="${{ github.actor }}"

          # Get user's association with the repository
          USER_ASSOCIATION=$(gh api "repos/${{ github.repository }}/collaborators/${ACTOR}/permission" --jq '.permission' 2>/dev/null || echo "none")

          # Check if user is org member (for org repos)
          IS_ORG_MEMBER="false"
          ORG_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          if gh api "orgs/${ORG_NAME}/members/${ACTOR}" >/dev/null 2>&1; then
            IS_ORG_MEMBER="true"
          fi

          # Allowed if: admin, write access, org member, or in explicit allow list
          ALLOWED_USERS=""
          IS_ALLOWED="false"

          if [ "${USER_ASSOCIATION}" = "admin" ] || [ "${USER_ASSOCIATION}" = "write" ]; then
            IS_ALLOWED="true"
            echo "✓ User has ${USER_ASSOCIATION} permission"
          elif [ "${IS_ORG_MEMBER}" = "true" ]; then
            IS_ALLOWED="true"
            echo "✓ User is organization member"
          elif [ -n "${ALLOWED_USERS}" ]; then
            for allowed in ${ALLOWED_USERS}; do
              if [ "${ACTOR}" = "${allowed}" ]; then
                IS_ALLOWED="true"
                echo "✓ User is in allowed users list"
                break
              fi
            done
          fi

          if [ "${IS_ALLOWED}" = "false" ]; then
            echo "::warning::User @${ACTOR} is not authorized to trigger this agent"
            echo "validation-failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
      - name: Check rate limit
        id: check-rate-limit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          RATE_LIMIT_MINUTES=5

          # Get recent workflow runs for this workflow
          RECENT_RUNS=$(gh api "repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/runs" \
            --jq "[.workflow_runs[] | select(.status == \"completed\" and .conclusion == \"success\")] | .[0:5] | .[].created_at" 2>/dev/null || echo "")

          if [ -n "${RECENT_RUNS}" ]; then
            CURRENT_TIME=$(date +%s)

            for run_time in ${RECENT_RUNS}; do
              RUN_TIMESTAMP=$(date -d "${run_time}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "${run_time}" +%s 2>/dev/null || echo "0")
              TIME_DIFF=$(( (CURRENT_TIME - RUN_TIMESTAMP) / 60 ))

              if [ "${TIME_DIFF}" -lt "${RATE_LIMIT_MINUTES}" ]; then
                echo "::warning::Rate limit: Agent ran ${TIME_DIFF} minutes ago. Minimum interval is ${RATE_LIMIT_MINUTES} minutes."
                echo "validation-failed=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            done
          fi
          echo "✓ Rate limit check passed"
      - name: Set output
        id: set-output
        run: |-
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "✓ All validation checks passed"

  claude-agent:
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.should-run == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install Claude Code CLI
        run: bunx --bun @anthropic-ai/claude-code --version
      - name: Setup GitHub MCP Server
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          mkdir -p ~/.config/claude-code && cat > ~/.config/claude-code/mcp.json << 'MCP_EOF'
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "$GITHUB_TOKEN"
                }
              }
            }
          }
          MCP_EOF
      - name: Prepare context file
        id: prepare
        run: |-
          cat > /tmp/context.txt << 'CONTEXT_EOF'
          GitHub Event: ${{ github.event_name }}
          Repository: ${{ github.repository }}
          CONTEXT_EOF
      - name: Add issue context
        if: github.event.issue.number
        run: |-
          cat >> /tmp/context.txt << 'ISSUE_EOF'
          Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
          Author: @${{ github.event.issue.user.login }}
          Body:
          ${{ github.event.issue.body }}
          ISSUE_EOF
      - name: Add PR context
        if: github.event.pull_request.number
        run: |-
          cat >> /tmp/context.txt << 'PR_EOF'
          PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          Author: @${{ github.event.pull_request.user.login }}
          Body:
          ${{ github.event.pull_request.body }}
          PR_EOF
      - name: Add available operations
        run: |-
          cat >> /tmp/context.txt << 'OPERATIONS_EOF'

          ---
          # Available Operations

          You are authorized to perform the following operations in this workflow. Use these operations to complete your assigned task.

          ## Operation: Add Comment

          Add a comment to the current issue or pull request.

          **How to use:**
          - Use \`mcp__github__add_issue_comment\` tool
          - Works for both issues and pull requests
          - Provide the comment body as markdown text
          - Be constructive and professional in your comments

          **Constraints:**
          - Maximum comments: 1

          **Example:**
          \`\`\`
          Use the mcp__github__add_issue_comment tool with:
          - owner: repository owner
          - repo: repository name
          - issue_number: current issue/PR number
          - body: "Your markdown comment here"
          \`\`\`

          ## Operation: Add Labels

          Add labels to the current issue or pull request.

          **How to use:**
          - Use \`mcp__github__update_issue\` tool to add labels
          - Works for both issues and pull requests
          - Provide an array of label names to add
          - Note: Labels must already exist in the repository
          - This operation adds to existing labels (doesn't replace them)

          **Example:**
          \`\`\`
          Use the mcp__github__update_issue tool with:
          - owner: repository owner
          - repo: repository name
          - issue_number: current issue/PR number
          - labels: ["bug", "needs-triage"]  # Labels to add
          \`\`\`

          OPERATIONS_EOF
      - name: Add agent instructions
        run: |-
          cat >> /tmp/context.txt << 'INSTRUCTIONS_EOF'

          ---

          # Pull Request Review Agent

          You are a helpful code review assistant.

          ## Your Task

          When a pull request is opened or updated:

          1. **Analyze Changes**: Review the diff and understand what's being changed

          2. **Check for Issues**:
             - Missing tests for new functionality
             - Potentially breaking changes
             - Code style inconsistencies
             - Security concerns
             - Documentation updates needed

          3. **Provide Feedback**: Add a comment with:
             - A brief summary of the changes
             - Any concerns or suggestions
             - Praise for good practices
             - Request for tests if needed

          4. **Add Labels**:
             - \`needs-tests\` if tests are missing
             - \`breaking-change\` if it's a breaking change
             - \`needs-docs\` if documentation is missing
             - \`ready-for-review\` if it looks good

          ## Guidelines

          - Be constructive and encouraging
          - Focus on significant issues, not nitpicks
          - Explain *why* something might be a concern
          - Remember: you're here to help, not to block progress
          - Acknowledge what's done well

          ## Available Actions

          You have access to GitHub MCP tools for safe interactions:
          - Use the GitHub MCP tools to add comments to pull requests
          - Use the GitHub MCP tools to add labels to pull requests
          - The tools are namespaced as \`mcp__github__*\` and provide structured, safe access to GitHub operations

          Example workflow:
          1. Analyze the PR changes using Read/Grep/Glob tools
          2. Review for potential issues
          3. Draft constructive feedback
          4. Use GitHub MCP to post your review comment (max 1 per run)
          5. Use GitHub MCP to add appropriate labels
          INSTRUCTIONS_EOF
      - name: Run Claude Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bunx --bun @anthropic-ai/claude-code -p "$(cat /tmp/context.txt)" --allowedTools "mcp__github__*,Bash(git*),Read,Glob,Grep"
