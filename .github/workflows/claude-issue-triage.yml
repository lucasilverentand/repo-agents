name: Issue Triage
'on':
  issues:
    types:
      - opened
permissions:
  contents: read
  issues: write
jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.set-output.outputs.should-run }}
    steps:
      - name: Check secrets
        id: check-secrets
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
        run: |-
          if [ -z "${ANTHROPIC_API_KEY}" ] && [ -z "${CLAUDE_ACCESS_TOKEN}" ]; then
            echo "::error::No Claude authentication found. Please set either ANTHROPIC_API_KEY (for API access) or CLAUDE_ACCESS_TOKEN (for subscription) in your repository secrets."
            echo "validation-failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -n "${ANTHROPIC_API_KEY}" ]; then
            echo "✓ ANTHROPIC_API_KEY is configured (API access)"
          fi
          if [ -n "${CLAUDE_ACCESS_TOKEN}" ]; then
            echo "✓ CLAUDE_ACCESS_TOKEN is configured (subscription access)"
          fi
      - name: Check user authorization
        id: check-user
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          ACTOR="${{ github.actor }}"

          # Get user's association with the repository
          USER_ASSOCIATION=$(gh api "repos/${{ github.repository }}/collaborators/${ACTOR}/permission" --jq '.permission' 2>/dev/null || echo "none")

          # Check if user is org member (for org repos)
          IS_ORG_MEMBER="false"
          ORG_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          if gh api "orgs/${ORG_NAME}/members/${ACTOR}" >/dev/null 2>&1; then
            IS_ORG_MEMBER="true"
          fi

          # Allowed if: admin, write access, org member, or in explicit allow list
          ALLOWED_USERS=""
          IS_ALLOWED="false"

          if [ "${USER_ASSOCIATION}" = "admin" ] || [ "${USER_ASSOCIATION}" = "write" ]; then
            IS_ALLOWED="true"
            echo "✓ User has ${USER_ASSOCIATION} permission"
          elif [ "${IS_ORG_MEMBER}" = "true" ]; then
            IS_ALLOWED="true"
            echo "✓ User is organization member"
          elif [ -n "${ALLOWED_USERS}" ]; then
            for allowed in ${ALLOWED_USERS}; do
              if [ "${ACTOR}" = "${allowed}" ]; then
                IS_ALLOWED="true"
                echo "✓ User is in allowed users list"
                break
              fi
            done
          fi

          if [ "${IS_ALLOWED}" = "false" ]; then
            echo "::warning::User @${ACTOR} is not authorized to trigger this agent"
            echo "validation-failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
      - name: Check rate limit
        id: check-rate-limit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          RATE_LIMIT_MINUTES=1

          # Get recent workflow runs for this workflow
          RECENT_RUNS=$(gh api "repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/runs" \
            --jq "[.workflow_runs[] | select(.status == \"completed\" and .conclusion == \"success\")] | .[0:5] | .[].created_at" 2>/dev/null || echo "")

          if [ -n "${RECENT_RUNS}" ]; then
            CURRENT_TIME=$(date +%s)

            for run_time in ${RECENT_RUNS}; do
              RUN_TIMESTAMP=$(date -d "${run_time}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "${run_time}" +%s 2>/dev/null || echo "0")
              TIME_DIFF=$(( (CURRENT_TIME - RUN_TIMESTAMP) / 60 ))

              if [ "${TIME_DIFF}" -lt "${RATE_LIMIT_MINUTES}" ]; then
                echo "::warning::Rate limit: Agent ran ${TIME_DIFF} minutes ago. Minimum interval is ${RATE_LIMIT_MINUTES} minutes."
                echo "validation-failed=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            done
          fi
          echo "✓ Rate limit check passed"
      - name: Set output
        id: set-output
        run: |-
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "✓ All validation checks passed"

  claude-agent:
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-run == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install Claude Code CLI
        run: bunx --bun @anthropic-ai/claude-code --version
      - name: Prepare context file
        id: prepare
        run: |-
          cat > /tmp/context.txt << 'CONTEXT_EOF'
          GitHub Event: ${{ github.event_name }}
          Repository: ${{ github.repository }}
          CONTEXT_EOF
      - name: Add issue context
        if: github.event.issue.number
        run: |-
          cat >> /tmp/context.txt << 'ISSUE_EOF'
          Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
          Author: @${{ github.event.issue.user.login }}
          Body:
          ${{ github.event.issue.body }}
          ISSUE_EOF
      - name: Add PR context
        if: github.event.pull_request.number
        run: |-
          cat >> /tmp/context.txt << 'PR_EOF'
          PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          Author: @${{ github.event.pull_request.user.login }}
          Body:
          ${{ github.event.pull_request.body }}
          PR_EOF
      - name: Add agent instructions
        run: |-
          cat >> /tmp/context.txt << 'INSTRUCTIONS_EOF'

          ---

          # Issue Triage Agent

          You are an intelligent issue triage assistant for the gh-claude project.

          ## Project Context

          gh-claude is a GitHub CLI extension that helps users create Claude-powered GitHub Actions workflows. It:
          - Parses markdown agent definitions from \`.github/claude-agents/\`
          - Generates GitHub Actions workflow YAML files
          - Supports triggers for issues, PRs, discussions, schedules, etc.
          - Includes pre-validation for authorization, rate limiting, and label requirements

          ## Your Task

          When a new issue is opened, analyze it and:

          1. **Analyze the issue** - Read the title and body to understand what the user is asking for or reporting

          2. **Categorize** the issue by adding ONE of these labels:
             - \`bug\` - Something isn't working as expected
             - \`enhancement\` - New feature or improvement request
             - \`question\` - User needs help or clarification
             - \`documentation\` - Documentation improvements needed

          3. **Assess Priority** if clearly warranted:
             - \`priority: high\` - Security issues, data loss, or blocking bugs
             - \`priority: low\` - Nice-to-have improvements

          4. **Welcome** the contributor with a helpful comment that:
             - Acknowledges the issue and thanks them for contributing
             - Confirms your understanding of the problem/request
             - If it's a bug: asks for any missing reproduction steps
             - If it's a feature: briefly notes if it aligns with project goals
             - Keeps it concise and friendly

          ## Guidelines

          - Be friendly and welcoming, especially to new contributors
          - Don't make promises about timelines or implementation
          - If the issue is unclear, politely ask for more information
          - If unsure about categorization, err on the side of \`question\`
          - If it's a duplicate, mention similar existing issues (if you're aware of them)
          - Keep responses concise and helpful

          ## Available Actions

          Use the \`gh\` CLI to interact with GitHub:
          - \`gh issue edit <number> --add-label <label>\` - Add labels
          - \`gh issue comment <number> --body "<message>"\` - Add comments
          INSTRUCTIONS_EOF
      - name: Run Claude Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bunx --bun @anthropic-ai/claude-code -p "$(cat /tmp/context.txt)" --allowedTools "Bash(git*),Bash(gh*),Read,Glob,Grep"
