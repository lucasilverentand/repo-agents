name: Issue Triage
'on':
  issues:
    types:
      - opened
permissions:
  contents: read
  issues: write
jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.set-output.outputs.should-run }}
    steps:
      - name: Check secrets
        id: check-secrets
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |-
          if [ -z "${ANTHROPIC_API_KEY}" ] && [ -z "${CLAUDE_CODE_OAUTH_TOKEN}" ]; then
            echo "::error::No Claude authentication found. Please set either ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN in your repository secrets."
            echo "validation-failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -n "${ANTHROPIC_API_KEY}" ]; then
            echo "✓ ANTHROPIC_API_KEY is configured"
          fi
          if [ -n "${CLAUDE_CODE_OAUTH_TOKEN}" ]; then
            echo "✓ CLAUDE_CODE_OAUTH_TOKEN is configured"
          fi
      - name: Check user authorization
        id: check-user
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          ACTOR="${{ github.actor }}"

          # Get user's association with the repository
          USER_ASSOCIATION=$(gh api "repos/${{ github.repository }}/collaborators/${ACTOR}/permission" --jq '.permission' 2>/dev/null || echo "none")

          # Check if user is org member (for org repos)
          IS_ORG_MEMBER="false"
          ORG_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          if gh api "orgs/${ORG_NAME}/members/${ACTOR}" >/dev/null 2>&1; then
            IS_ORG_MEMBER="true"
          fi

          # Allowed if: admin, write access, org member, or in explicit allow list
          ALLOWED_USERS=""
          IS_ALLOWED="false"

          if [ "${USER_ASSOCIATION}" = "admin" ] || [ "${USER_ASSOCIATION}" = "write" ]; then
            IS_ALLOWED="true"
            echo "✓ User has ${USER_ASSOCIATION} permission"
          elif [ "${IS_ORG_MEMBER}" = "true" ]; then
            IS_ALLOWED="true"
            echo "✓ User is organization member"
          elif [ -n "${ALLOWED_USERS}" ]; then
            for allowed in ${ALLOWED_USERS}; do
              if [ "${ACTOR}" = "${allowed}" ]; then
                IS_ALLOWED="true"
                echo "✓ User is in allowed users list"
                break
              fi
            done
          fi

          if [ "${IS_ALLOWED}" = "false" ]; then
            echo "::warning::User @${ACTOR} is not authorized to trigger this agent"
            echo "validation-failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
      - name: Check rate limit
        id: check-rate-limit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          RATE_LIMIT_MINUTES=1

          # Get recent workflow runs for this workflow
          RECENT_RUNS=$(gh api "repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/runs" \
            --jq "[.workflow_runs[] | select(.status == \"completed\" and .conclusion == \"success\")] | .[0:5] | .[].created_at" 2>/dev/null || echo "")

          if [ -n "${RECENT_RUNS}" ]; then
            CURRENT_TIME=$(date +%s)

            for run_time in ${RECENT_RUNS}; do
              RUN_TIMESTAMP=$(date -d "${run_time}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "${run_time}" +%s 2>/dev/null || echo "0")
              TIME_DIFF=$(( (CURRENT_TIME - RUN_TIMESTAMP) / 60 ))

              if [ "${TIME_DIFF}" -lt "${RATE_LIMIT_MINUTES}" ]; then
                echo "::warning::Rate limit: Agent ran ${TIME_DIFF} minutes ago. Minimum interval is ${RATE_LIMIT_MINUTES} minutes."
                echo "validation-failed=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            done
          fi
          echo "✓ Rate limit check passed"
      - name: Set output
        id: set-output
        run: |-
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "✓ All validation checks passed"

  claude-agent:
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.should-run == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install Claude Code CLI
        run: bunx --bun @anthropic-ai/claude-code --version
      - name: Create outputs directory
        run: mkdir -p /tmp/outputs /tmp/validation-errors
      - name: Prepare context file
        id: prepare
        run: |-
          cat > /tmp/context.txt << 'CONTEXT_EOF'
          GitHub Event: ${{ github.event_name }}
          Repository: ${{ github.repository }}
          CONTEXT_EOF
      - name: Add issue context
        if: github.event.issue.number
        run: |-
          cat >> /tmp/context.txt << 'ISSUE_EOF'
          Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
          Author: @${{ github.event.issue.user.login }}
          Body:
          ${{ github.event.issue.body }}
          ISSUE_EOF
      - name: Add PR context
        if: github.event.pull_request.number
        run: |-
          cat >> /tmp/context.txt << 'PR_EOF'
          PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          Author: @${{ github.event.pull_request.user.login }}
          Body:
          ${{ github.event.pull_request.body }}
          PR_EOF
      - name: Fetch add-label context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          # Fetch available labels for context
          LABELS_JSON=$(gh api "repos/${{ github.repository }}/labels" --jq '[.[].name]' 2>/dev/null || echo '[]')
          LABELS_LIST=$(echo "$LABELS_JSON" | jq -r 'join(", ")' 2>/dev/null || echo "No labels available")

          cat >> /tmp/context.txt << 'LABELS_EOF'

          ## Available Repository Labels

          The following labels are available in this repository:
          $LABELS_LIST

          **Important**: You can only add labels that already exist. New labels cannot be created by this agent.

          LABELS_EOF
      - name: Create Claude skills file
        run: |-
          mkdir -p /tmp/claude && cat > /tmp/claude/CLAUDE.md << 'SKILLS_EOF'
          # Agent Output Skills

          This file documents how to create outputs for this agent.

          ## Skill: Add Comment

          Add a comment to the current issue or pull request.

          **File to create**: \`/tmp/outputs/add-comment.json\`

          **JSON Schema**:
          \`\`\`json
          {
            "body": "string"
          }
          \`\`\`

          **Fields**:
          - \`body\` (required): Markdown-formatted comment text

          **Constraints**:
          - Maximum comments: 1
          - Body must be non-empty

          **Example**:
          Create \`/tmp/outputs/add-comment.json\` with:
          \`\`\`json
          {
            "body": "Thank you for reporting this issue! I've analyzed it and added appropriate labels."
          }
          \`\`\`

          **Important**: Use the Write tool to create this file. Only create the file when you're ready to post the comment.

          ## Skill: Add Labels

          Add one or more labels to the current issue or pull request.

          **Available labels**: See the "Available Repository Labels" section in the context above for the complete list of labels you can use.

          **File to create**: \`/tmp/outputs/add-label.json\`

          **JSON Schema**:
          \`\`\`json
          {
            "labels": ["string"]
          }
          \`\`\`

          **Fields**:
          - \`labels\` (required): Array of label names to add

          **Constraints**:
          - Labels must already exist in the repository (see available labels above)
          - Labels array must be non-empty
          - Duplicate labels will be ignored
          - This operation adds to existing labels (doesn't replace them)

          **Example**:
          Create \`/tmp/outputs/add-label.json\` with:
          \`\`\`json
          {
            "labels": ["bug", "priority: high"]
          }
          \`\`\`

          **Important**: Use the Write tool to create this file. Only add labels that exist in the available labels list.

          SKILLS_EOF
      - name: Add agent instructions
        run: |-
          cat >> /tmp/context.txt << 'INSTRUCTIONS_EOF'

          ---

          # Issue Triage Agent

          You are an intelligent issue triage assistant for the gh-claude project.

          ## Project Context

          gh-claude is a GitHub CLI extension that helps users create Claude-powered GitHub Actions workflows. It:
          - Parses markdown agent definitions from \`.github/claude-agents/\`
          - Generates GitHub Actions workflow YAML files
          - Supports triggers for issues, PRs, discussions, schedules, etc.
          - Includes pre-validation for authorization, rate limiting, and label requirements

          ## Your Task

          When a new issue is opened, analyze it and:

          1. **Analyze the issue** - Read the title and body to understand what the user is asking for or reporting

          2. **Categorize** the issue by adding ONE of these labels:
             - \`bug\` - Something isn't working as expected
             - \`enhancement\` - New feature or improvement request
             - \`question\` - User needs help or clarification
             - \`documentation\` - Documentation improvements needed

          3. **Assess Priority** if clearly warranted:
             - \`priority: high\` - Security issues, data loss, or blocking bugs
             - \`priority: low\` - Nice-to-have improvements

          4. **Welcome** the contributor with a helpful comment that:
             - Acknowledges the issue and thanks them for contributing
             - Confirms your understanding of the problem/request
             - If it's a bug: asks for any missing reproduction steps
             - If it's a feature: briefly notes if it aligns with project goals
             - Keeps it concise and friendly

          ## Guidelines

          - Be friendly and welcoming, especially to new contributors
          - Don't make promises about timelines or implementation
          - If the issue is unclear, politely ask for more information
          - If unsure about categorization, err on the side of \`question\`
          - If it's a duplicate, mention similar existing issues (if you're aware of them)
          - Keep responses concise and helpful

          ## Available Actions

          You have access to GitHub MCP tools for safe interactions:
          - Use the GitHub MCP tools to add labels to issues
          - Use the GitHub MCP tools to add comments to issues
          - The tools are namespaced as \`mcp__github__*\` and provide structured, safe access to GitHub operations

          Example workflow:
          1. Analyze the issue content
          2. Decide on appropriate label(s)
          3. Use GitHub MCP to add the label
          4. Draft a welcoming comment
          5. Use GitHub MCP to post the comment
          INSTRUCTIONS_EOF
      - name: Run Claude Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: cd /tmp/claude && bunx --bun @anthropic-ai/claude-code -p "$(cat /tmp/context.txt)" --allowedTools "Write(/tmp/outputs/*),Read,Glob,Grep"
      - name: Validate and execute outputs
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |

          # Validate and execute add-comment output
          if [ -f "/tmp/outputs/add-comment.json" ]; then
            echo "Validating add-comment output..."

            # Validate JSON structure
            if ! jq empty /tmp/outputs/add-comment.json 2>/dev/null; then
              echo "- **add-comment**: Invalid JSON format" > /tmp/validation-errors/add-comment.txt
            else
              # Extract body
              COMMENT_BODY=$(jq -r '.body' /tmp/outputs/add-comment.json)

              # Validate body is non-empty
              if [ -z "$COMMENT_BODY" ] || [ "$COMMENT_BODY" = "null" ]; then
                echo "- **add-comment**: Comment body is empty or missing" > /tmp/validation-errors/add-comment.txt
              elif [ ${#COMMENT_BODY} -gt 65536 ]; then
                echo "- **add-comment**: Comment body exceeds 65536 characters" > /tmp/validation-errors/add-comment.txt
              else
                # Validation passed - execute
                echo "✓ add-comment validation passed"

                # Check if we have an issue/PR number
                ISSUE_NUMBER="${{ github.event.issue.number }}"
                if [ -z "$ISSUE_NUMBER" ]; then
                  echo "- **add-comment**: No issue or PR number available" > /tmp/validation-errors/add-comment.txt
                else
                  # Add comment via GitHub API
                  gh api "repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments" \
                    -f body="$COMMENT_BODY" || {
                    echo "- **add-comment**: Failed to post comment via GitHub API" > /tmp/validation-errors/add-comment.txt
                  }
                fi
              fi
            fi
          fi


          # Validate and execute add-label output
          if [ -f "/tmp/outputs/add-label.json" ]; then
            echo "Validating add-label output..."

            # Validate JSON structure
            if ! jq empty /tmp/outputs/add-label.json 2>/dev/null; then
              echo "- **add-label**: Invalid JSON format" > /tmp/validation-errors/add-label.txt
            else
              # Extract labels array
              LABELS_ARRAY=$(jq -r '.labels' /tmp/outputs/add-label.json 2>/dev/null)

              # Validate labels is an array
              if [ "$LABELS_ARRAY" = "null" ] || ! echo "$LABELS_ARRAY" | jq -e 'type == "array"' >/dev/null 2>&1; then
                echo "- **add-label**: labels field must be an array" > /tmp/validation-errors/add-label.txt
              elif [ "$(echo "$LABELS_ARRAY" | jq 'length')" -eq 0 ]; then
                echo "- **add-label**: labels array cannot be empty" > /tmp/validation-errors/add-label.txt
              else
                # Fetch existing labels from repository
                EXISTING_LABELS=$(gh api "repos/${{ github.repository }}/labels" --jq '[.[].name]' 2>/dev/null || echo '[]')

                # Validate each label exists
                INVALID_LABELS=""
                for label in $(echo "$LABELS_ARRAY" | jq -r '.[]'); do
                  if ! echo "$EXISTING_LABELS" | jq -e --arg label "$label" 'index($label)' >/dev/null 2>&1; then
                    if [ -z "$INVALID_LABELS" ]; then
                      INVALID_LABELS="$label"
                    else
                      INVALID_LABELS="$INVALID_LABELS, $label"
                    fi
                  fi
                done

                # If there are invalid labels, write error and skip execution
                if [ -n "$INVALID_LABELS" ]; then
                  echo "- **add-label**: The following labels do not exist in the repository: $INVALID_LABELS" > /tmp/validation-errors/add-label.txt
                else
                  # Validation passed - execute
                  echo "✓ add-label validation passed"

                  # Check if we have an issue/PR number
                  ISSUE_NUMBER="${{ github.event.issue.number }}"
                  if [ -z "$ISSUE_NUMBER" ]; then
                    echo "- **add-label**: No issue or PR number available" > /tmp/validation-errors/add-label.txt
                  else
                    # Get current labels and merge with new ones to avoid overwriting
                    CURRENT_LABELS=$(gh api "repos/${{ github.repository }}/issues/$ISSUE_NUMBER" --jq '.labels[].name' 2>/dev/null | jq -R . | jq -s .)
                    NEW_LABELS=$(echo "$LABELS_ARRAY" | jq -r '.[]' | jq -R . | jq -s .)
                    MERGED_LABELS=$(echo "$CURRENT_LABELS" "$NEW_LABELS" | jq -s 'add | unique')

                    # Add labels via GitHub API
                    echo "$MERGED_LABELS" | gh api "repos/${{ github.repository }}/issues/$ISSUE_NUMBER/labels" \
                      -X PUT \
                      --input - || {
                      echo "- **add-label**: Failed to add labels via GitHub API" > /tmp/validation-errors/add-label.txt
                    }
                  fi
                fi
              fi
            fi
          fi


          # Report validation errors if any exist
          if [ -d "/tmp/validation-errors" ] && [ "$(ls -A /tmp/validation-errors 2>/dev/null)" ]; then
            echo "⚠️  Some output validations failed"

            # Build error message
            ERROR_MSG="## ⚠️ Agent Output Validation Errors

          The following outputs failed validation:

          "

            for error_file in /tmp/validation-errors/*; do
              if [ -f "$error_file" ]; then
                ERROR_CONTENT=$(cat "$error_file")
                ERROR_MSG="${ERROR_MSG}${ERROR_CONTENT}
          "
              fi
            done

            # Post comment if we have issue/PR number
            ISSUE_OR_PR_NUMBER="${{ github.event.issue.number }}"
            if [ -n "$ISSUE_OR_PR_NUMBER" ]; then
              echo "$ERROR_MSG" | gh api "repos/${{ github.repository }}/issues/$ISSUE_OR_PR_NUMBER/comments" \
                -X POST \
                --input - \
                -f body=@- || echo "Failed to post validation error comment"
            else
              echo "No issue or PR number available to post validation errors"
              echo -e "$ERROR_MSG"
            fi
          else
            echo "✓ All output validations passed"
          fi
