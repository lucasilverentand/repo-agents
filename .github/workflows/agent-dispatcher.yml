name: Claude Agent Dispatcher
'on':
  issues:
    types:
      - labeled
      - opened
  workflow_dispatch:
    inputs:
      agent:
        description: Specific agent to run (leave empty to auto-route based on event)
        required: false
        type: string
permissions:
  actions: write
  contents: write
  issues: write
  pull-requests: write
jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      should-continue: ${{ steps.global-preflight.outputs.should-continue }}
      app-token: ${{ steps.global-preflight.outputs.app-token }}
      git-user: ${{ steps.global-preflight.outputs.git-user }}
      git-email: ${{ steps.global-preflight.outputs.git-email }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Global pre-flight check
        id: global-preflight
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_APP_ID: ${{ secrets.GH_APP_ID }}
          GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FALLBACK_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun packages/runtime/src/index.ts run dispatcher:global-preflight

  prepare-context:
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.should-continue == 'true'
    outputs:
      run-id: ${{ steps.prepare-context.outputs.run-id }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Prepare dispatch context
        id: prepare-context
        run: bun packages/runtime/src/index.ts run dispatcher:prepare-context
      - name: Upload context artifact
        uses: actions/upload-artifact@v4
        with:
          name: dispatch-context-${{ github.run_id }}
          path: /tmp/dispatch-context/
          retention-days: '1'

  route-event:
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.should-continue == 'true'
    outputs:
      matching-agents: ${{ steps.route.outputs.matching-agents }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Route event to agents
        id: route
        env:
          WORKFLOW_DISPATCH_AGENT: ${{ github.event.inputs.agent }}
          GITHUB_EVENT_SCHEDULE: ${{ github.event.schedule }}
        run: bun packages/runtime/src/index.ts run dispatcher:route --agents-dir .github/agents

  dispatch-agents:
    runs-on: ubuntu-latest
    needs:
      - pre-flight
      - prepare-context
      - route-event
    if: needs.route-event.outputs.matching-agents != '[]'
    strategy:
      matrix:
        agent: ${{ fromJson(needs.route-event.outputs.matching-agents) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Download dispatch context
        uses: actions/download-artifact@v4
        with:
          name: dispatch-context-${{ needs.prepare-context.outputs.run-id }}
          path: /tmp/dispatch-context/
      - name: Validate dispatch for ${{ matrix.agent.agentName }}
        id: validate-dispatch
        run: bun packages/runtime/src/index.ts run dispatcher:dispatch --agent ${{ matrix.agent.agentPath }} --workflow-file ${{ matrix.agent.workflowFile }}
      - name: Upload validation audit
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-audit-${{ matrix.agent.agentName }}-${{ github.run_id }}
          path: /tmp/artifacts/validation-audit/
      - name: Dispatch to ${{ matrix.agent.agentName }}
        if: steps.validate-dispatch.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ needs.pre-flight.outputs.app-token || github.token }}
        run: |-
          echo "Triggering workflow: ${{ matrix.agent.workflowFile }}"
          echo "Agent: ${{ matrix.agent.agentName }}"

          gh workflow run "${{ matrix.agent.workflowFile }}" \
            --ref "${{ github.ref }}" \
            -f context-run-id="${{ needs.prepare-context.outputs.run-id }}"

          echo "âœ“ Dispatched to ${{ matrix.agent.agentName }}"
      - name: Skip notification
        if: steps.validate-dispatch.outputs.should-run != 'true'
        run: 'echo "::notice::Skipping ${{ matrix.agent.agentName }}: ${{ steps.validate-dispatch.outputs.skip-reason || ''Validation failed'' }}"'
