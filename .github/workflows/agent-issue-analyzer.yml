name: Issue Analyzer
'on':
  workflow_dispatch:
    inputs:
      progress-comment-id:
        type: string
        required: false
        description: Progress comment ID (from dispatcher)
      progress-issue-number:
        type: string
        required: false
        description: Issue/PR number for progress comment (from dispatcher)
      target-issue-number:
        type: string
        required: false
        description: Target issue/PR number for outputs (from dispatcher)
      event-payload:
        type: string
        required: false
        description: Original event payload JSON (from dispatcher)
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      should-continue: ${{ steps.setup.outputs.should-continue }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Validate Claude authentication
        id: setup
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: bun packages/runtime/src/index.ts run setup --agent .github/agents/issue-lifecycle/issue-analyzer.md

  agent:
    runs-on: ubuntu-latest
    needs:
      - setup
    if: needs.setup.outputs.should-continue == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        if: vars.GH_APP_ID != '' && secrets.GH_APP_PRIVATE_KEY != ''
        continue-on-error: true
      - name: 'Update progress: agent running'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-analyzer.md --progress-stage agent --progress-status running --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          # Use app identity if token was created, otherwise use github-actions[bot]
          if [ -n "${{ steps.app-token.outputs.token }}" ]; then
            # Extract app slug from token (requires gh CLI)
            APP_SLUG=$(gh api /app --jq '.slug' 2>/dev/null || echo "github-app")
            APP_ID=$(gh api /app --jq '.id' 2>/dev/null || echo "0")
            git config --global user.name "${APP_SLUG}[bot]"
            git config --global user.email "${APP_ID}+${APP_SLUG}[bot]@users.noreply.github.com"
          else
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
      - id: run
        run: bun packages/runtime/src/index.ts run agent --agent .github/agents/issue-lifecycle/issue-analyzer.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ inputs.event-payload }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-outputs-${{ github.run_id }}
          path: /tmp/outputs/
      - uses: actions/upload-artifact@v4
        with:
          name: audit-metrics-${{ github.run_id }}
          path: /tmp/audit/
      - name: 'Update progress: agent success'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-analyzer.md --progress-stage agent --progress-status success --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        continue-on-error: true

  execute-outputs:
    runs-on: ubuntu-latest
    needs:
      - setup
      - agent
    strategy:
      matrix:
        output-type:
          - add-comment
          - add-label
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        if: vars.GH_APP_ID != '' && secrets.GH_APP_PRIVATE_KEY != ''
        continue-on-error: true
      - name: Download output files
        uses: actions/download-artifact@v4
        with:
          name: claude-outputs-${{ github.run_id }}
          path: /tmp/outputs/
      - name: 'Update progress: outputs running'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-analyzer.md --progress-stage outputs --progress-status running --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
        if: strategy.job-index == 0
      - name: Execute ${{ matrix.output-type }} outputs
        run: bun packages/runtime/src/index.ts run outputs --agent .github/agents/issue-lifecycle/issue-analyzer.md --output-type ${{ matrix.output-type }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          TARGET_ISSUE_NUMBER: ${{ inputs.target-issue-number }}

  audit-report:
    runs-on: ubuntu-latest
    needs:
      - setup
      - agent
      - execute-outputs
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        if: vars.GH_APP_ID != '' && secrets.GH_APP_PRIVATE_KEY != ''
        continue-on-error: true
      - uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ github.run_id }}'
          path: /tmp/audit-data/
          merge-multiple: true
        continue-on-error: true
      - run: |-
          bun packages/runtime/src/index.ts run audit --agent .github/agents/issue-lifecycle/issue-analyzer.md \
                      --agent-result ${{ needs.agent.result }} \
                      --execute-outputs-result ${{ needs.execute-outputs.result }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
      - name: Read final comment
        id: final-comment
        if: needs.agent.result == 'success'
        run: |-
          if [ -f /tmp/audit-data/add-comment.json ]; then
            COMMENT=$(jq -r '.body // empty' /tmp/audit-data/add-comment.json 2>/dev/null || true)
            if [ -n "$COMMENT" ]; then
              echo "has-comment=true" >> $GITHUB_OUTPUT
              # Escape for shell
              ESCAPED=$(echo "$COMMENT" | sed 's/"/\"/g' | tr '\n' ' ')
              echo "comment=$ESCAPED" >> $GITHUB_OUTPUT
            fi
          fi
        continue-on-error: true
      - name: 'Update progress: complete with comment'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-analyzer.md --progress-stage complete --progress-status success --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}" --progress-final-comment "${{ steps.final-comment.outputs.comment }}"
        if: needs.agent.result == 'success' && steps.final-comment.outputs.has-comment == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: 'Update progress: complete'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-analyzer.md --progress-stage complete --progress-status success --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}"
        if: needs.agent.result == 'success' && steps.final-comment.outputs.has-comment != 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: 'Update progress: failed'
        run: bun packages/runtime/src/index.ts run progress --agent .github/agents/issue-lifecycle/issue-analyzer.md --progress-stage failed --progress-status failed --progress-comment-id "${{ inputs.progress-comment-id }}" --progress-issue-number "${{ inputs.progress-issue-number }}" --progress-error "Workflow failed"
        if: needs.agent.result != 'success'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        continue-on-error: true
permissions:
  issues: write
