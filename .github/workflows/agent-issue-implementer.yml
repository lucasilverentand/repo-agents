name: Issue Implementer
'on':
  workflow_dispatch:
    inputs:
      context-run-id:
        type: string
        required: true
jobs:
  claude-agent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Download dispatch context
        uses: actions/download-artifact@v4
        with:
          name: dispatch-context-${{ inputs.context-run-id }}
          path: /tmp/dispatch-context/
          run-id: ${{ inputs.context-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - id: run
        run: bun packages/runtime/src/index.ts run agent --agent .github/agents/issue-lifecycle/issue-implementer.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-outputs-${{ github.run_id }}
          path: /tmp/outputs/
      - uses: actions/upload-artifact@v4
        with:
          name: audit-metrics-${{ github.run_id }}
          path: /tmp/audit/

  execute-outputs:
    runs-on: ubuntu-latest
    needs: claude-agent
    strategy:
      matrix:
        output-type:
          - create-pr
          - add-comment
          - add-label
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Download dispatch context
        uses: actions/download-artifact@v4
        with:
          name: dispatch-context-${{ inputs.context-run-id }}
          path: /tmp/dispatch-context/
          run-id: ${{ inputs.context-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download output files
        uses: actions/download-artifact@v4
        with:
          name: claude-outputs-${{ github.run_id }}
          path: /tmp/outputs/
      - name: Execute ${{ matrix.output-type }} outputs
        run: bun packages/runtime/src/index.ts run outputs --agent .github/agents/issue-lifecycle/issue-implementer.md --output-type ${{ matrix.output-type }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  audit-report:
    runs-on: ubuntu-latest
    needs:
      - claude-agent
      - execute-outputs
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ github.run_id }}'
          path: /tmp/audit-data/
          merge-multiple: true
        continue-on-error: true
      - run: |-
          bun packages/runtime/src/index.ts run audit --agent .github/agents/issue-lifecycle/issue-implementer.md \
                      --claude-agent-result ${{ needs.claude-agent.result }} \
                      --execute-outputs-result ${{ needs.execute-outputs.result }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
permissions:
  contents: write
  issues: write
  pull-requests: write
