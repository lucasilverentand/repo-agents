name: AI Agents
"on":
  issues:
    types:
      - labeled
      - opened
  pull_request:
    types:
      - closed
  workflow_dispatch:
    inputs:
      agent:
        description: Specific agent to run (leave empty to auto-route)
        required: false
        type: string
permissions:
  actions: write
  contents: write
  issues: write
  pull-requests: write
jobs:
  dispatcher:
    runs-on: ubuntu-latest
    outputs:
      agent-issue-analyzer-should-run: ${{ steps.dispatcher.outputs.agent-issue-analyzer-should-run }}
      agent-issue-analyzer-skip-reason: ${{ steps.dispatcher.outputs.agent-issue-analyzer-skip-reason }}
      agent-issue-analyzer-event-payload: ${{ steps.dispatcher.outputs.agent-issue-analyzer-event-payload }}
      agent-issue-formatter-should-run: ${{ steps.dispatcher.outputs.agent-issue-formatter-should-run }}
      agent-issue-formatter-skip-reason: ${{ steps.dispatcher.outputs.agent-issue-formatter-skip-reason }}
      agent-issue-formatter-event-payload: ${{ steps.dispatcher.outputs.agent-issue-formatter-event-payload }}
      agent-issue-implementer-should-run: ${{ steps.dispatcher.outputs.agent-issue-implementer-should-run }}
      agent-issue-implementer-skip-reason: ${{ steps.dispatcher.outputs.agent-issue-implementer-skip-reason }}
      agent-issue-implementer-event-payload: ${{ steps.dispatcher.outputs.agent-issue-implementer-event-payload }}
      agent-issue-triage-should-run: ${{ steps.dispatcher.outputs.agent-issue-triage-should-run }}
      agent-issue-triage-skip-reason: ${{ steps.dispatcher.outputs.agent-issue-triage-skip-reason }}
      agent-issue-triage-event-payload: ${{ steps.dispatcher.outputs.agent-issue-triage-event-payload }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Dispatch agents
        id: dispatcher
        run: bun run repo-agent run dispatcher
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_DISPATCH_AGENT: ${{ inputs.agent }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  agent-issue-analyzer:
    runs-on: ubuntu-latest
    needs: dispatcher
    if: needs.dispatcher.outputs.agent-issue-analyzer-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}"
          git config --global user.email "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}@users.noreply.github.com"
      - name: Run Issue Analyzer
        run: bun run repo-agent run agent --agent "Issue Analyzer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-analyzer-event-payload }}
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-analyzer-outputs-${{ github.run_id }}
          path: /tmp/outputs/
          retention-days: "7"
      - if: always()
        name: Upload audit metrics
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-analyzer-audit-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "7"

  agent-issue-analyzer-outputs:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-analyzer
    if: needs.agent-issue-analyzer.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-analyzer-outputs-${{ github.run_id }}
          path: /tmp/outputs/
        continue-on-error: true
      - name: Execute outputs
        run: bun run repo-agent run outputs --agent "Issue Analyzer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-analyzer-event-payload }}

  agent-issue-analyzer-audit:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-analyzer
    if: always() && needs.dispatcher.outputs.agent-issue-analyzer-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download audit metrics
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-analyzer-audit-${{ github.run_id }}
          path: /tmp/artifacts/
        continue-on-error: true
      - name: Generate audit report
        run: bun run repo-agent run audit --agent "Issue Analyzer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          AGENT_RESULT: ${{ needs.agent-issue-analyzer.result }}

  agent-issue-formatter:
    runs-on: ubuntu-latest
    needs: dispatcher
    if: needs.dispatcher.outputs.agent-issue-formatter-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}"
          git config --global user.email "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}@users.noreply.github.com"
      - name: Run Issue Formatter
        run: bun run repo-agent run agent --agent "Issue Formatter"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-formatter-event-payload }}
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-formatter-outputs-${{ github.run_id }}
          path: /tmp/outputs/
          retention-days: "7"
      - if: always()
        name: Upload audit metrics
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-formatter-audit-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "7"

  agent-issue-formatter-outputs:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-formatter
    if: needs.agent-issue-formatter.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-formatter-outputs-${{ github.run_id }}
          path: /tmp/outputs/
        continue-on-error: true
      - name: Execute outputs
        run: bun run repo-agent run outputs --agent "Issue Formatter"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-formatter-event-payload }}

  agent-issue-formatter-audit:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-formatter
    if: always() && needs.dispatcher.outputs.agent-issue-formatter-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download audit metrics
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-formatter-audit-${{ github.run_id }}
          path: /tmp/artifacts/
        continue-on-error: true
      - name: Generate audit report
        run: bun run repo-agent run audit --agent "Issue Formatter"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          AGENT_RESULT: ${{ needs.agent-issue-formatter.result }}

  agent-issue-implementer:
    runs-on: ubuntu-latest
    needs: dispatcher
    if: needs.dispatcher.outputs.agent-issue-implementer-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}"
          git config --global user.email "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}@users.noreply.github.com"
      - name: Run Issue Implementer
        run: bun run repo-agent run agent --agent "Issue Implementer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-implementer-event-payload }}
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-implementer-outputs-${{ github.run_id }}
          path: /tmp/outputs/
          retention-days: "7"
      - if: always()
        name: Upload audit metrics
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-implementer-audit-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "7"

  agent-issue-implementer-outputs:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-implementer
    if: needs.agent-issue-implementer.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-implementer-outputs-${{ github.run_id }}
          path: /tmp/outputs/
        continue-on-error: true
      - name: Execute outputs
        run: bun run repo-agent run outputs --agent "Issue Implementer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-implementer-event-payload }}

  agent-issue-implementer-audit:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-implementer
    if: always() && needs.dispatcher.outputs.agent-issue-implementer-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download audit metrics
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-implementer-audit-${{ github.run_id }}
          path: /tmp/artifacts/
        continue-on-error: true
      - name: Generate audit report
        run: bun run repo-agent run audit --agent "Issue Implementer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          AGENT_RESULT: ${{ needs.agent-issue-implementer.result }}

  agent-issue-triage:
    runs-on: ubuntu-latest
    needs: dispatcher
    if: needs.dispatcher.outputs.agent-issue-triage-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}"
          git config --global user.email "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}@users.noreply.github.com"
      - name: Run Issue Triage
        run: bun run repo-agent run agent --agent "Issue Triage"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-triage-event-payload }}
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-triage-outputs-${{ github.run_id }}
          path: /tmp/outputs/
          retention-days: "7"
      - if: always()
        name: Upload audit metrics
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-triage-audit-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "7"

  agent-issue-triage-outputs:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-triage
    if: needs.agent-issue-triage.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-triage-outputs-${{ github.run_id }}
          path: /tmp/outputs/
        continue-on-error: true
      - name: Execute outputs
        run: bun run repo-agent run outputs --agent "Issue Triage"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-triage-event-payload }}

  agent-issue-triage-audit:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-triage
    if: always() && needs.dispatcher.outputs.agent-issue-triage-should-run == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download audit metrics
        uses: actions/download-artifact@v4
        with:
          name: agent-issue-triage-audit-${{ github.run_id }}
          path: /tmp/artifacts/
        continue-on-error: true
      - name: Generate audit report
        run: bun run repo-agent run audit --agent "Issue Triage"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          AGENT_RESULT: ${{ needs.agent-issue-triage.result }}
