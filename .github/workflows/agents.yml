name: AI Agents
"on":
  issues:
    types:
      - edited
      - labeled
      - opened
  pull_request:
    types:
      - closed
  workflow_dispatch:
    inputs:
      agent:
        description: Specific agent to run (leave empty to auto-route)
        required: false
        type: string
concurrency:
  group: agents-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number || github.event.discussion.number || github.run_id }}
  cancel-in-progress: ${{ !(endsWith(github.actor, '[bot]') && (github.event.action == 'edited' || github.event.action == 'labeled')) }}
permissions:
  actions: write
  contents: write
  issues: write
  pull-requests: write
jobs:
  dispatcher:
    runs-on: ubuntu-latest
    if: "!(endsWith(github.actor, '[bot]') && (github.event.action == 'edited' || github.event.action == 'labeled'))"
    outputs:
      agent-issue-implementer-should-run: ${{ steps.dispatcher.outputs.agent-issue-implementer-should-run }}
      agent-issue-implementer-skip-reason: ${{ steps.dispatcher.outputs.agent-issue-implementer-skip-reason }}
      agent-issue-implementer-event-payload: ${{ steps.dispatcher.outputs.agent-issue-implementer-event-payload }}
      agent-issue-quality-should-run: ${{ steps.dispatcher.outputs.agent-issue-quality-should-run }}
      agent-issue-quality-skip-reason: ${{ steps.dispatcher.outputs.agent-issue-quality-skip-reason }}
      agent-issue-quality-event-payload: ${{ steps.dispatcher.outputs.agent-issue-quality-event-payload }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Dispatch agents
        id: dispatcher
        run: bun run repo-agent run dispatcher
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_DISPATCH_AGENT: ${{ inputs.agent }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  agent-issue-implementer:
    runs-on: ubuntu-latest
    needs: dispatcher
    if: needs.dispatcher.outputs.agent-issue-implementer-should-run == 'true'
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}"
          git config --global user.email "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}@users.noreply.github.com"
      - name: Run Issue Implementer
        run: bun run repo-agent run agent --agent "Issue Implementer"
        timeout-minutes: 30
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-implementer-event-payload }}
      - name: Execute outputs
        run: bun run repo-agent run outputs --agent "Issue Implementer"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-implementer-event-payload }}
      - if: always()
        name: Upload audit metrics
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-implementer-audit-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "7"

  agent-issue-quality:
    runs-on: ubuntu-latest
    needs: dispatcher
    if: needs.dispatcher.outputs.agent-issue-quality-should-run == 'true'
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Configure git identity
        run: |-
          git config --global user.name "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}"
          git config --global user.email "${{ steps.app-token.outputs.app-slug || 'github-actions[bot]' }}@users.noreply.github.com"
      - name: Run Issue Quality
        run: bun run repo-agent run agent --agent "Issue Quality"
        timeout-minutes: 30
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-quality-event-payload }}
      - name: Execute outputs
        run: bun run repo-agent run outputs --agent "Issue Quality"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          EVENT_PAYLOAD: ${{ needs.dispatcher.outputs.agent-issue-quality-event-payload }}
      - if: always()
        name: Upload audit metrics
        uses: actions/upload-artifact@v4
        with:
          name: agent-issue-quality-audit-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "7"

  audit-report:
    runs-on: ubuntu-latest
    needs:
      - dispatcher
      - agent-issue-implementer
      - agent-issue-quality
    if: always()
    outputs:
      has-failures: ${{ steps.report.outputs.has-failures }}
      failed-agents: ${{ steps.report.outputs.failed-agents }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Download all audit artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: agent-*-audit-*
          path: /tmp/all-audits/
        continue-on-error: true
      - name: Generate audit report
        id: report
        run: bun run repo-agent run audit-report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JOB_RESULTS: ${{ toJSON(needs) }}
      - name: Write job summary
        run: cat /tmp/audit/summary.md >> $GITHUB_STEP_SUMMARY
        if: always()
        continue-on-error: true
      - name: Upload audit manifest
        uses: actions/upload-artifact@v4
        with:
          name: audit-manifest-${{ github.run_id }}
          path: /tmp/audit/
          retention-days: "30"
        if: always()

  audit-issues:
    runs-on: ubuntu-latest
    needs:
      - audit-report
    if: always() && needs.audit-report.outputs.has-failures == 'true'
    strategy:
      matrix:
        agent: ${{ fromJSON(needs.audit-report.outputs.failed-agents) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        continue-on-error: true
      - name: Download audit manifest
        uses: actions/download-artifact@v4
        with:
          name: audit-manifest-${{ github.run_id }}
          path: /tmp/audit/
      - name: Create failure issue
        run: bun run repo-agent run audit-issues --agent "${{ matrix.agent }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          MATRIX_AGENT: ${{ matrix.agent }}
