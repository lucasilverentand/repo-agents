---
title: Dispatcher Stage
slug: stages/dispatcher
description: Centralized event routing and pre-flight checks
sidebar:
  label: 1. Dispatcher
---

The dispatcher is a centralized workflow that routes events to the appropriate agents and performs pre-flight checks. It aggregates triggers from all agents into a single entry point and uses a routing table to match incoming events to the right agents, dispatching them using a matrix strategy. Before dispatching, it validates API authentication, checks user authorization (admin, allowed users, or team members), enforces rate limiting, and validates trigger labels if configured. When a GitHub App is configured, its token is generated here. If any check fails, execution stops immediately.

## When It Runs

The dispatcher runs for **all event-based triggers**:
- Issue events (opened, labeled, etc.)
- Pull request events (opened, synchronize, etc.)
- Discussion events
- Scheduled events (cron)
- Repository dispatch events
- Manual workflow dispatch

## Pre-Flight Checks

Before dispatching to agents, the following checks are performed:

### 1. Generate GitHub Token

Creates a GitHub App token if configured, otherwise uses the default `GITHUB_TOKEN`.

Using a GitHub App provides:
- Branded identity (commits appear as "YourApp[bot]")
- PRs created by the agent can trigger CI workflows
- Higher rate limits

### 2. Check Secrets

Verifies that one of the required authentication secrets exists:

- `ANTHROPIC_API_KEY` — Anthropic API key
- `CLAUDE_CODE_OAUTH_TOKEN` — Claude OAuth token

If neither is configured, the workflow fails immediately.

### 3. Check User Authorization

Validates the triggering user has permission to run the agent.

**Default allowed users:**
- Repository admins
- Users with write access
- Organization members

You can restrict this further with `allowed-actors` and `allowed-teams` in your agent definition.

### 4. Check Required Labels

If `trigger_labels` is configured, verifies the issue/PR has one of the required labels. The agent only runs if a matching label is present.

### 5. Check Rate Limit

Prevents excessive runs by enforcing a minimum interval between executions. The default is 5 minutes, configurable via `rate_limit_minutes`.

## Event Routing

After pre-flight checks pass, the dispatcher routes events:

### 1. Prepare Context

Builds a shared context object with event data:
- Dispatch metadata (ID, timestamp, run URL)
- Event type and action
- Event-specific data (issue details, PR details, etc.)
- Uploads context as an artifact for agent workflows

### 2. Route Event

Matches the event against a routing table:
- Each agent defines which events it handles
- Multiple agents can match the same event
- Manual dispatch can target a specific agent by name

### 3. Dispatch Agents

Triggers matching agent workflows:
- Uses matrix strategy for parallel execution
- Passes context run ID to agent workflows
- Each agent runs independently

## Generated Workflow

The dispatcher workflow is generated by `repo-agents compile` and aggregates:
- All triggers from all agent definitions
- Permissions from all agents (union of requirements)
- A routing table mapping events to agent workflow files

```yaml
name: Claude Agent Dispatcher
on:
  issues:
    types: [opened, labeled]  # Union of all agent triggers
  pull_request:
    types: [opened, synchronize]
  schedule:
    - cron: '0 9 * * 1-5'
  workflow_dispatch:
    inputs:
      agent:
        description: 'Specific agent to run'
        required: false
```

## Pre-Flight Outputs

| Output | Description |
|--------|-------------|
| `should-run` | `true` if all checks pass, `false` otherwise |
| `rate-limited` | `true` if skipped due to rate limiting |
| `github-token` | Token for subsequent jobs |

## Failure Scenarios

| Check | Failure Reason | Resolution |
|-------|---------------|------------|
| Secrets | Missing API key | Run `repo-agents setup-token` |
| Authorization | User not allowed | Add to `allowed-actors` or grant write access |
| Labels | Required label missing | Add the trigger label to issue/PR |
| Rate Limit | Too soon since last run | Wait for cooldown or adjust `rate_limit_minutes` |
