---
title: Dispatcher Stage
slug: stages/dispatcher
description: Centralized event routing and pre-flight validation
sidebar:
  label: 1. Dispatcher
---

The dispatcher is a thin routing layer that routes events to the appropriate agents and performs pre-flight validation. It aggregates triggers from all agents into a single entry point and uses a routing table to match incoming events to the right agents, dispatching them using a matrix strategy. Before dispatching, it validates API authentication, checks user authorization (admin, allowed users, or team members), enforces rate limiting, and validates trigger labels if configured. If any check fails, execution stops immediately.

## Architecture

The dispatcher is intentionally minimal. Its responsibilities are:
1. **Global pre-flight** - Validate Claude authentication is configured
2. **Event routing** - Match events to agents based on trigger configuration
3. **Per-agent validation** - Authorization, rate limits, labels, blocking issues

Everything else happens in agent workflows:
- Token generation (setup job)
- Event context reading (directly from `$GITHUB_EVENT_PATH`)
- Claude execution
- Output execution

## When It Runs

The dispatcher runs for **all event-based triggers**:
- Issue events (opened, labeled, etc.)
- Pull request events (opened, synchronize, etc.)
- Discussion events
- Scheduled events (cron)
- Repository dispatch events
- Manual workflow dispatch

## Pre-Flight Checks

### 1. Global Pre-Flight

Verifies that one of the required authentication secrets exists:

- `ANTHROPIC_API_KEY` — Anthropic API key
- `CLAUDE_CODE_OAUTH_TOKEN` — Claude OAuth token

If neither is configured, the workflow fails immediately with a self-healing issue created in the repository.

### 2. Per-Agent Validation

For each matched agent, the dispatcher validates:

**User Authorization**
Validates the triggering user has permission to run the agent.

**Default allowed users:**
- Repository admins
- Users with write access
- Organization members

You can restrict this further with `allowed-actors` and `allowed-teams` in your agent definition.

**Required Labels**
If `trigger_labels` is configured, verifies the issue/PR has one of the required labels.

**Rate Limit**
Prevents excessive runs by enforcing a minimum interval between executions. The default is 5 minutes, configurable via `rate_limit_minutes`.

**Blocking Issues**
If `pre_flight.check_blocking_issues` is enabled, checks if the issue has blocking dependencies.

**Max Open PRs**
If `max_open_prs` is configured, checks that the agent hasn't exceeded the limit.

## Event Routing

### 1. Route Event

Matches the event against a routing table:
- Each agent defines which events it handles
- Multiple agents can match the same event
- Manual dispatch can target a specific agent by name

### 2. Dispatch Agents

Triggers matching agent workflows:
- Uses matrix strategy for parallel execution
- Passes progress comment info to agent workflows (if enabled)
- Each agent runs independently

## Generated Workflow

The dispatcher workflow is generated by `repo-agents compile` and has 3 jobs:

```yaml
name: Agent Dispatcher
on:
  issues:
    types: [opened, labeled]  # Union of all agent triggers
  pull_request:
    types: [opened, synchronize]
  schedule:
    - cron: '0 9 * * 1-5'
  workflow_dispatch:
    inputs:
      agent:
        description: 'Specific agent to run'
        required: false

jobs:
  pre-flight:
    # Validates Claude auth is configured

  route-event:
    # Discovers agents and matches event

  dispatch-agents:
    # Per-agent validation and dispatch (matrix strategy)
```

## Outputs

| Output | Description |
|--------|-------------|
| `should-run` | `true` if all checks pass, `false` otherwise |
| `skip-reason` | Reason for skipping if validation failed |
| `progress-comment-id` | ID of progress comment (if enabled) |
| `progress-issue-number` | Issue/PR number for progress comment |

## Failure Scenarios

| Check | Failure Reason | Resolution |
|-------|---------------|------------|
| Secrets | Missing API key | Run `repo-agents setup-token` |
| Authorization | User not allowed | Add to `allowed-actors` or grant write access |
| Labels | Required label missing | Add the trigger label to issue/PR |
| Rate Limit | Too soon since last run | Wait for cooldown or adjust `rate_limit_minutes` |
| Blocking Issues | Issue has open blockers | Resolve blocking issues first |
| Max Open PRs | Too many open PRs | Close or merge existing PRs |
